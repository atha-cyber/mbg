<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cetak Laporan MBG - SMPN 4 Pandak</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* Gaya Tampilan Layar (Screen) */
        @media screen {
            .print-preview {
                background: white;
                width: 210mm;
                min-height: 297mm;
                margin: 20px auto;
                padding: 20mm;
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
                border-radius: 8px;
            }
        }

        /* Gaya Khusus Cetak (Print) */
        @media print {
            @page { size: A4; margin: 15mm; }
            body { background: white; padding: 0; }
            .no-print { display: none !important; }
            .print-preview { 
                width: 100%; 
                margin: 0; 
                padding: 0; 
                box-shadow: none;
            }
        }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #000; padding: 10px; text-align: center; }
        th { background-color: #f2f2f2 !important; font-weight: bold; }
        .header-logo { height: 80px; width: auto; }
    </style>
</head>
<body class="p-4">

    <!-- Tombol Kontrol (Hanya muncul di layar) -->
    <div class="no-print max-w-4xl mx-auto mb-6 flex justify-between items-center bg-white p-4 rounded-xl shadow-sm">
        <div>
            <h2 class="text-xl font-bold text-gray-800">Mode Cetak Laporan (PC)</h2>
            <p class="text-sm text-gray-500">Gunakan tombol di samping untuk mencetak langsung ke Printer.</p>
        </div>
        <div class="flex gap-2">
            <button onclick="window.location.reload()" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg font-bold transition">Refresh Data</button>
            <button onclick="window.print()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold shadow-lg transition flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/><path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4V3zm1 5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5V8zm0 4h6v1a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-1z"/></svg>
                Cetak Laporan
            </button>
        </div>
    </div>

    <!-- Area Pratinjau Laporan -->
    <div class="print-preview" id="report-content">
        <!-- KOP SURAT -->
        <div class="flex justify-between items-center border-b-4 border-black pb-4 mb-6">
            <img src="https://raw.githubusercontent.com/atha-cyber/logo-/main/images.jfif" class="header-logo">
            <div class="text-center">
                <h1 class="text-3xl font-black uppercase tracking-tighter">LAPORAN HARIAN KEHADIRAN</h1>
                <h2 class="text-xl font-bold">Program Makan Bergizi (MBG) SMPN 4 Pandak</h2>
                <p id="print-date" class="text-lg font-semibold mt-1"></p>
            </div>
            <img src="https://raw.githubusercontent.com/atha-cyber/logo-/main/logo-bgn.png" class="header-logo">
        </div>

        <!-- RINGKASAN DATA -->
        <div class="grid grid-cols-2 gap-4 mb-8">
            <div class="border-2 border-black p-4 text-center">
                <p class="text-sm font-bold uppercase">Total Porsi Terpakai (Hadir)</p>
                <p id="total-present" class="text-5xl font-black">0</p>
            </div>
            <div class="border-2 border-black p-4 text-center">
                <p class="text-sm font-bold uppercase">Sisa Porsi Hari Ini</p>
                <p id="total-remaining" class="text-5xl font-black text-red-600">0</p>
            </div>
        </div>

        <!-- TABEL RINCIAN -->
        <table>
            <thead>
                <tr>
                    <th style="width: 10%;">No</th>
                    <th style="width: 30%;">Kelas / Rombel</th>
                    <th style="width: 20%;">Jumlah Hadir</th>
                    <th style="width: 40%;">Keterangan / Catatan</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <!-- Data akan diisi otomatis oleh JS -->
                <tr><td colspan="4" class="p-8">Memuat data dari database...</td></tr>
            </tbody>
            <tfoot>
                <tr class="font-bold">
                    <td colspan="2">TOTAL KESELURUHAN</td>
                    <td id="grand-total-footer">0</td>
                    <td></td>
                </tr>
            </tfoot>
        </table>

        <!-- TANDA TANGAN -->
        <div class="mt-16 grid grid-cols-2 text-center">
            <div></div>
            <div>
                <p>Pandak, <span id="footer-date"></span></p>
                <p class="mt-1">Petugas Pelaksana,</p>
                <div class="h-24"></div>
                <p class="font-bold underline">( _________________________ )</p>
                <p class="text-sm">NIP/NIPPPK. ..................................</p>
            </div>
        </div>
        
        <div class="mt-10 text-[10px] text-gray-400 italic no-print text-center">
            Sistem Digital MBG SMPN 4 Pandak - Dicetak secara otomatis.
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCFoiJXBRwJkCmAVSOVb0za1vLlB58Eugc",
            authDomain: "mbg4-329e3.firebaseapp.com",
            projectId: "mbg4-329e3",
            storageBucket: "mbg4-329e3.appspot.com",
            messagingSenderId: "13330785414",
            appId: "1:13330785414:web:99505859877a60a2311d07"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Pengaturan Tanggal
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'Asia/Jakarta' };
        const dateStrLong = now.toLocaleDateString('id-ID', options);
        document.getElementById('print-date').textContent = dateStrLong;
        document.getElementById('footer-date').textContent = now.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });

        // Format ID Dokumen Firebase (YYYY-MM-DD)
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const docId = `rekap-${year}-${month}-${day}`;

        const CLASSES = {
            'Kelas VII': ['A', 'B', 'C', 'D', 'E'],
            'Kelas VIII': ['A', 'B', 'C', 'D', 'E'],
            'Kelas IX': ['A', 'B', 'C', 'D', 'E']
        };

        // Real-time listener dari Firestore
        onSnapshot(doc(db, "kehadiran", docId), (snap) => {
            if (snap.exists()) {
                const data = snap.data();
                renderTable(data);
            } else {
                document.getElementById('table-body').innerHTML = `<tr><td colspan="4" class="p-8 text-red-500 font-bold">Data untuk hari ini (${docId}) belum tersedia di database.</td></tr>`;
            }
        });

        function renderTable(data) {
            let html = '';
            let totalAll = 0;
            let counter = 1;

            for (const [level, rombels] of Object.entries(CLASSES)) {
                const levelRoman = level.split(' ')[1];
                rombels.forEach(rb => {
                    const id = `${levelRoman}${rb}`;
                    const count = data[id] || 0;
                    totalAll += count;

                    html += `
                        <tr>
                            <td>${counter++}</td>
                            <td class="text-left px-6 font-semibold">${level} - Rombel ${rb}</td>
                            <td class="font-bold">${count}</td>
                            <td></td>
                        </tr>
                    `;
                });
            }

            document.getElementById('table-body').innerHTML = html;
            document.getElementById('total-present').textContent = totalAll;
            document.getElementById('grand-total-footer').textContent = totalAll;
            document.getElementById('total-remaining').textContent = 472 - totalAll;
        }
    </script>
</body>
</html>
