<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Kehadiran - Program Makan Bergizi | SMPN 4 Pandak</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://github.com/atha-cyber/logo-/raw/main/%E2%80%94Pngtree%E2%80%94c4d%20neon%20cool%20background_1113037.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
        }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; }

        .skeleton-loader {
            background-color: #e2e8f0;
            border-radius: 0.5rem;
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            50% { opacity: .5; }
        }
        
        .animate-blinking-opacity {
            animation: blinking-opacity 1.5s ease-in-out infinite;
        }

        @keyframes blinking-opacity {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .animate-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        .animate-marquee {
            animation: marquee 25s linear infinite;
            display: flex;
        }

        @media print {
            body { 
                background-image: none !important;
                background-color: white !important; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact; 
            }
            .no-print { display: none !important; }
            #login-modal, #unlock-modal { display: none !important; }
            #main-dashboard { display: block !important; }
            .container { max-width: 100%; padding: 0; margin: 0; }
            section, .attendance-card, #summary-section { box-shadow: none !important; border: 1px solid #e5e7eb; page-break-inside: avoid; }
            .attendance-card { transform: none !important; }
            .attendance-input { display: none !important; }
            .attendance-display { display: block !important; }
            h1, h2, h3, p, span { color: black !important; }
            .bg-blue-50, .bg-green-50, .bg-purple-50, .bg-gray-100 { background-color: #f9fafb !important; }
            .animate-blinking-opacity, .animate-pulse, .animate-marquee { animation: none !important; }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="w-full max-w-sm mx-auto bg-black/30 backdrop-blur-xl border border-white/20 rounded-2xl shadow-lg p-8 text-white">
            <h2 class="text-2xl font-bold text-center mb-2">Autentikasi Diperlukan</h2>
            <p class="text-center text-gray-300 mb-6">Masukkan kode akses untuk melanjutkan.</p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="password-input" class="sr-only">Password</label>
                    <input type="password" id="password-input" placeholder="****" class="w-full bg-gray-900/50 text-white text-center text-2xl tracking-[1em] border-2 border-gray-500 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition" autocomplete="off">
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-50">Masuk</button>
            </form>
            <p id="error-message" class="text-red-400 text-center mt-4 h-5"></p>
        </div>
    </div>
    
    <!-- Unlock Modal -->
    <div id="unlock-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 backdrop-blur-sm flex items-center justify-center z-50 p-4 no-print">
        <div class="w-full max-w-sm mx-auto bg-black/30 backdrop-blur-xl border border-white/20 rounded-2xl shadow-lg p-8 text-white">
            <h2 class="text-2xl font-bold text-center mb-2">Buka Kunci Edit</h2>
            <p class="text-center text-gray-300 mb-6">Masukkan kata sandi superuser.</p>
            <form id="unlock-form">
                <div class="mb-4">
                    <label for="unlock-password-input" class="sr-only">Password</label>
                    <input type="password" id="unlock-password-input" placeholder="***" class="w-full bg-gray-900/50 text-white text-center text-2xl tracking-[1em] border-2 border-gray-500 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 transition" autocomplete="off">
                </div>
                <button type="submit" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-opacity-50">Buka Kunci</button>
                 <button type="button" id="cancel-unlock-btn" class="w-full mt-2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition">Batal</button>
            </form>
            <p id="unlock-error-message" class="text-red-400 text-center mt-4 h-5"></p>
        </div>
    </div>


    <!-- Main Dashboard Content (Hidden by default) -->
    <div id="main-dashboard" class="hidden">
        <audio id="scroll-sound" src="https://raw.githubusercontent.com/atha-cyber/logo-/main/mixkit-fast-whoosh-transition-1490.wav" preload="auto"></audio>
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <header class="relative mb-8 rounded-2xl shadow-lg p-6 sm:p-8 bg-black/20 backdrop-blur-md border border-white/20">
                <div class="relative z-10 grid grid-cols-[auto_1fr_auto] items-center w-full gap-4">
                    <div class="flex justify-start">
                        <div class="h-16 w-16 sm:h-20 sm:w-20 rounded-full shadow-lg border border-white/30 flex-shrink-0" 
                             style="background-image: url('https://raw.githubusercontent.com/atha-cyber/logo-/main/images.jfif'); background-size: cover; background-position: center;">
                        </div>
                    </div>
                    <div class="text-center min-w-0">
                        <h1 class="text-2xl sm:text-3xl md:text-4xl font-extrabold text-white tracking-tight drop-shadow-md">Dasbor Kehadiran Siswa</h1>
                        <div class="relative flex overflow-x-hidden mt-1">
                            <div class="animate-marquee">
                                <span class="text-base md:text-lg text-gray-200 font-semibold drop-shadow-md whitespace-nowrap flex-shrink-0 px-8">PROGRAM MAKAN BERGIZI GRATIS - SMP NEGERI 4 PANDAK</span>
                                <span class="text-base md:text-lg text-gray-200 font-semibold drop-shadow-md whitespace-nowrap flex-shrink-0 px-8" aria-hidden="true">PROGRAM MAKAN BERGIZI GRATIS - SMP NEGERI 4 PANDAK</span>
                            </div>
                        </div>
                        <p id="current-date" class="mt-3 text-gray-200 bg-white/20 px-4 py-1 rounded-full inline-block text-sm"></p>
                    </div>
                    <div class="flex justify-end">
                        <img src="https://raw.githubusercontent.com/atha-cyber/logo-/main/logo-bgn.png" alt="Logo Badan Gizi Nasional" class="h-16 w-16 sm:h-20 sm:w-20 object-contain drop-shadow-lg flex-shrink-0">
                    </div>
                </div>
            </header>

            <main id="attendance-grid" class="space-y-8"></main>
            
            <section id="summary-section" class="bg-black/20 backdrop-blur-md p-5 rounded-2xl shadow-lg mt-8 border border-white/20">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-white">Rangkuman Hari Ini</h3>
                    <button id="print-btn" class="no-print bg-gray-700 hover:bg-gray-800 text-white p-2 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5 1a2 2 0 0 0-2 2v1h10V3a2 2 0 0 0-2-2zm6 8H5a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1"/><path d="M0 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v-2a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2H2a2 2 0 0 1-2-2zm2.5 1a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1"/></svg>
                    </button>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div class="bg-blue-900/30 p-4 rounded-xl border border-blue-400/50">
                        <p class="text-sm text-blue-200 font-semibold">Hadir Kelas VII</p>
                        <p id="total-vii" class="text-3xl font-bold text-blue-300">0</p>
                    </div>
                    <div class="bg-green-900/30 p-4 rounded-xl border border-green-400/50">
                        <p class="text-sm text-green-200 font-semibold">Hadir Kelas VIII</p>
                        <p id="total-viii" class="text-3xl font-bold text-green-300">0</p>
                    </div>
                    <div class="bg-purple-900/30 p-4 rounded-xl border border-purple-400/50">
                        <p class="text-sm text-purple-200 font-semibold">Hadir Kelas IX</p>
                        <p id="total-ix" class="text-3xl font-bold text-purple-300">0</p>
                    </div>
                    <div class="bg-gray-700/30 p-4 rounded-xl col-span-2 md:col-span-1 grid grid-cols-2 gap-4 md:grid-cols-1 md:gap-1 border border-gray-400/50">
                        <div>
                            <p class="text-sm text-gray-200 font-bold">TOTAL HADIR</p>
                            <p id="total-present" class="text-4xl font-extrabold text-white">0</p>
                        </div>
                        <div class="md:border-t md:border-gray-300/30 md:mt-1 md:pt-1">
                            <p class="text-sm text-gray-200 font-bold">SISA PORSI</p>
                            <p id="remaining-portions" class="text-2xl font-extrabold text-red-400 animate-blinking-opacity">472</p>
                        </div>
                    </div>
                </div>
            </section>

            <footer class="text-center mt-10 pt-6 border-t border-white/20 no-print">
                <p class="text-sm text-gray-200">&copy; 2025 SMP Negeri 4 Pandak. Digitalisasi untuk Pendidikan.</p>
            </footer>
        </div>

        <div id="notification-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 p-4 no-print transition-opacity duration-300">
            <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 w-full max-w-sm text-center transform transition-all scale-95 opacity-0" id="notification-content">
                <div id="notification-icon" class="mx-auto mb-4"></div>
                <p id="notification-message" class="text-lg text-gray-800 mb-6"></p>
                <button id="notification-ok-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-8 rounded-lg transition w-full">OK</button>
            </div>
        </div>

        <div id="mute-container" class="no-print fixed bottom-5 right-5 z-50">
            <button id="mute-btn" class="bg-gray-700/50 hover:bg-gray-800/70 backdrop-blur-sm text-white p-3 rounded-full shadow-lg transition-transform transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-white/50">
                <svg id="sound-on-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-.708.707A7.476 7.476 0 0 1 13.025 8c0 2.071-.84 3.946-2.197 5.303z"/>
                    <path d="M10.121 12.596A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.482 5.482 0 0 1 11.025 8a5.482 5.482 0 0 1-1.61 3.89z"/>
                    <path d="M8.707 11.182A4.486 4.486 0 0 0 10.025 8a4.486 4.486 0 0 0-1.318-3.182L8 5.525A3.489 3.489 0 0 1 9.025 8 3.49 3.49 0 0 1 8 10.475zM6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06z"/>
                </svg>
                <svg id="sound-off-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="hidden" viewBox="0 0 16 16">
                    <path d="M6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06zm7.137 2.096a.5.5 0 0 1 0 .708L12.207 8l1.647 1.646a.5.5 0 0 1-.708.708L11.5 8.707l-1.646 1.647a.5.5 0 0 1-.708-.708L10.793 8 9.146 6.354a.5.5 0 1 1 .708-.708L11.5 7.293l1.646-1.647a.5.5 0 0 1 .708 0z"/>
                </svg>
            </button>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const scrollSound = document.getElementById('scroll-sound');
        let hasUserInteracted = false; 

        function handleFirstInteraction() {
            if (hasUserInteracted) return;
            hasUserInteracted = true;
            if (scrollSound) {
                const playPromise = scrollSound.play();
                if (playPromise !== undefined) {
                    playPromise.then(_ => { scrollSound.pause(); }).catch(error => { console.error("Audio unlock failed:", error); });
                }
            }
            document.body.removeEventListener('click', handleFirstInteraction);
            document.body.removeEventListener('scroll', handleFirstInteraction);
        }

        document.body.addEventListener('click', handleFirstInteraction, { once: true });
        document.body.addEventListener('scroll', handleFirstInteraction, { once: true });

        let scrollTimeout = null;
        let isCurrentlyScrolling = false;
        window.addEventListener('scroll', () => {
            if (isMuted || !hasUserInteracted || !scrollSound) return;
            if (!isCurrentlyScrolling) {
                scrollSound.currentTime = 0;
                scrollSound.play().catch(e => console.error("Audio play failed:", e));
                isCurrentlyScrolling = true;
            }
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => { isCurrentlyScrolling = false; }, 200); 
        });

        const firebaseConfig = {
            apiKey: "AIzaSyCFoiJXBRwJkCmAVSOVb0za1vLlB58Eugc",
            authDomain: "mbg4-329e3.firebaseapp.com",
            projectId: "mbg4-329e3",
            storageBucket: "mbg4-329e3.appspot.com",
            messagingSenderId: "13330785414",
            appId: "1:13330785414:web:99505859877a60a2311d07"
        };

        let app, db;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            document.body.innerHTML = '<div class="h-screen w-screen flex items-center justify-center bg-red-100 text-red-700 p-4">Gagal menginisialisasi Firebase. Periksa konfigurasi.</div>';
        }
        
        const attendanceDocRef = doc(db, "kehadiran", "rekapHarian");

        const loginModal = document.getElementById('login-modal');
        const loginForm = document.getElementById('login-form');
        const passwordInput = document.getElementById('password-input');
        const errorMessage = document.getElementById('error-message');
        const mainDashboard = document.getElementById('main-dashboard');
        const dateElement = document.getElementById('current-date');
        const attendanceGrid = document.getElementById('attendance-grid');
        const printBtn = document.getElementById('print-btn');
        const notificationModal = document.getElementById('notification-modal');
        const notificationContent = document.getElementById('notification-content');
        const notificationMessage = document.getElementById('notification-message');
        const notificationOkBtn = document.getElementById('notification-ok-btn');
        const notificationIcon = document.getElementById('notification-icon');
        const muteBtn = document.getElementById('mute-btn');
        const soundOnIcon = document.getElementById('sound-on-icon');
        const soundOffIcon = document.getElementById('sound-off-icon');

        const unlockModal = document.getElementById('unlock-modal');
        const unlockForm = document.getElementById('unlock-form');
        const unlockPasswordInput = document.getElementById('unlock-password-input');
        const unlockErrorMessage = document.getElementById('unlock-error-message');
        const cancelUnlockBtn = document.getElementById('cancel-unlock-btn');
        
        let currentData = {};
        let isMuted = false;
        const TOTAL_SISWA_KESELURUHAN = 472;
        const CLASSES_CONFIG = {
            'Kelas VII': { color: 'blue', rombels: ['A', 'B', 'C', 'D', 'E'] },
            'Kelas VIII': { color: 'green', rombels: ['A', 'B', 'C', 'D', 'E'] },
            'Kelas IX': { color: 'purple', rombels: ['A', 'B', 'C', 'D', 'E'] }
        };
        
        const TARGET_LATITUDE = -7.926021;
        const TARGET_LONGITUDE = 110.298982;
        const MAX_DISTANCE_METERS = 400;

        let audioCtx;
        function initAudioContext() {
            if (hasUserInteracted && !audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playTone(frequency, duration) {
            if (isMuted || !hasUserInteracted) return;
            initAudioContext();
            if (!audioCtx) return;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.8, audioCtx.currentTime + 0.01);
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);
            oscillator.start(audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
            oscillator.stop(audioCtx.currentTime + duration);
        }

        function playSuccessSound() {
            playTone(523.25, 0.1); 
            setTimeout(() => playTone(659.25, 0.15), 100);
        }
        
        function renderSkeletonLoader() {
            let skeletonHtml = '';
            for (const details of Object.values(CLASSES_CONFIG)) {
                skeletonHtml += `
                    <div class="mb-8 p-4 rounded-2xl bg-white/10 backdrop-blur-md border border-white/20 shadow-md">
                        <div class="h-8 w-32 skeleton-loader mb-4"></div>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                            ${Array(5).fill('').map(() => `<div class="h-28 w-full skeleton-loader"></div>`).join('')}
                        </div>
                    </div>`;
            }
            attendanceGrid.innerHTML = skeletonHtml;
        }

        function renderAttendanceGrid(data) {
            let html = '';
            for (const [level, details] of Object.entries(CLASSES_CONFIG)) {
                const levelRoman = level.split(' ')[1];
                html += `
                <section class="bg-black/20 backdrop-blur-md p-4 sm:p-5 rounded-2xl shadow-lg border border-white/20" data-level="${levelRoman}">
                    <div class="flex justify-between items-center mb-4 pb-3 border-b border-white/20">
                        <h3 class="text-xl font-bold text-white">${level}</h3>
                        <div class="section-controls no-print flex items-center space-x-2">
                             <button class="edit-section-btn text-white px-2 py-1 text-xs rounded-md bg-blue-600/80 hover:bg-blue-600 transition-colors">Ubah Data</button>
                             <div class="edit-mode-controls-section hidden flex items-center space-x-2">
                                <button class="save-section-btn text-white px-2 py-1 text-xs rounded-md bg-green-600/80 hover:bg-green-600 transition-colors">Simpan</button>
                                <button class="cancel-section-btn text-white px-2 py-1 text-xs rounded-md bg-gray-600/80 hover:bg-gray-600 transition-colors">Batal</button>
                             </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">`;
                details.rombels.forEach(rombel => {
                    const classId = `${levelRoman}${rombel}`;
                    const count = data[classId] || 0;
                    html += `
                        <div class="attendance-card relative bg-white/10 rounded-xl border border-white/20 p-3 text-center transition-all duration-300 hover:shadow-lg hover:border-${details.color}-400/50 hover:-translate-y-1" data-class-id="${classId}">
                            <p class="text-base font-semibold text-gray-200">${levelRoman} ${rombel}</p>
                            <span class="attendance-display block text-4xl font-bold text-${details.color}-300 my-2">${count}</span>
                            <input type="number" class="attendance-input hidden w-full text-center text-4xl font-bold bg-gray-900/50 text-white border-2 border-${details.color}-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-${details.color}-400 my-2" value="${count}" min="0" max="50">
                            <p class="text-xs text-gray-400">Siswa Hadir</p>
                        </div>`;
                });
                html += `</div></section>`;
            }
            attendanceGrid.innerHTML = html;
            checkAndApplyLocks();
        }

        function updateSummary(data) {
            const totals = {};
            let totalHadir = 0;
            for(const [level, details] of Object.entries(CLASSES_CONFIG)) {
                const levelRoman = level.split(' ')[1];
                let levelTotal = 0;
                details.rombels.forEach(rombel => levelTotal += parseInt(data[`${levelRoman}${rombel}`], 10) || 0);
                totals[levelRoman] = levelTotal;
                totalHadir += levelTotal;
            }
            document.getElementById('total-vii').textContent = totals['VII'];
            document.getElementById('total-viii').textContent = totals['VIII'];
            document.getElementById('total-ix').textContent = totals['IX'];
            document.getElementById('total-present').textContent = totalHadir;
            document.getElementById('remaining-portions').textContent = TOTAL_SISWA_KESELURUHAN - totalHadir;
        }

        function getLocalDateString() {
            const now = new Date();
            return new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
        }

        function displayCurrentDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            dateElement.textContent = new Date().toLocaleDateString('id-ID', options);
        }

        function showNotification(message, status = 'success') {
            const icons = {
                success: `<svg class="w-16 h-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                error: `<svg class="w-16 h-16 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
            };
            notificationIcon.innerHTML = icons[status];
            notificationMessage.textContent = message;
            notificationModal.classList.remove('hidden');
            setTimeout(() => {
                notificationModal.style.opacity = '1';
                notificationContent.style.transform = 'scale(1)';
                notificationContent.style.opacity = '1';
            }, 10);
        }
        
        document.body.addEventListener('click', initAudioContext, { once: true });
        printBtn.addEventListener('click', () => window.print());
        notificationOkBtn.addEventListener('click', () => {
            notificationModal.style.opacity = '0';
            notificationContent.style.transform = 'scale(0.95)';
            notificationContent.style.opacity = '0';
            setTimeout(() => notificationModal.classList.add('hidden'), 300);
        });

        muteBtn.addEventListener('click', () => {
            isMuted = !isMuted;
            if (scrollSound) scrollSound.muted = isMuted;
            soundOnIcon.classList.toggle('hidden', isMuted);
            soundOffIcon.classList.toggle('hidden', !isMuted);
            if (isMuted && scrollSound && !scrollSound.paused) {
                scrollSound.pause();
            }
        });

        function getLockKey(levelRoman) {
            return `lock_level_${levelRoman}_${getLocalDateString()}`;
        }
        
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function lockSection(section) {
            const editBtn = section.querySelector('.edit-section-btn');
            editBtn.disabled = true;
            editBtn.classList.remove('bg-blue-600/80', 'hover:bg-blue-600');
            editBtn.classList.add('bg-gray-500', 'cursor-not-allowed');
            editBtn.textContent = 'Tersimpan';
        }

        function checkAndApplyLocks() {
            document.querySelectorAll('section[data-level]').forEach(section => {
                const levelRoman = section.dataset.level;
                if (localStorage.getItem(getLockKey(levelRoman)) === 'true') {
                    lockSection(section);
                }
            });
        }
        
        attendanceGrid.addEventListener('click', async (e) => {
            const section = e.target.closest('section[data-level]');
            if (!section) return;

            const editBtn = e.target.closest('.edit-section-btn');
            const saveBtn = e.target.closest('.save-section-btn');
            const cancelBtn = e.target.closest('.cancel-section-btn');

            if (editBtn) {
                 const originalButtonText = editBtn.textContent;
                editBtn.disabled = true;
                editBtn.textContent = '...';

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        const distance = getDistance(TARGET_LATITUDE, TARGET_LONGITUDE, latitude, longitude);

                        if (distance <= MAX_DISTANCE_METERS) {
                            playTone(440, 0.1);
                            section.querySelectorAll('.attendance-display').forEach(el => el.classList.add('hidden'));
                            section.querySelectorAll('.attendance-input').forEach(el => el.classList.remove('hidden'));
                            section.querySelector('.edit-section-btn').classList.add('hidden');
                            section.querySelector('.edit-mode-controls-section').classList.remove('hidden');
                        } else {
                            showNotification(`Anda berada ${Math.round(distance)}m dari lokasi. Akses ditolak.`, "error");
                        }
                        editBtn.disabled = false;
                        editBtn.textContent = originalButtonText;
                    },
                    (error) => {
                        showNotification(error.code === 1 ? "Izin lokasi ditolak." : "Gagal mendapatkan lokasi.", "error");
                        editBtn.disabled = false;
                        editBtn.textContent = originalButtonText;
                    }
                );
            } else if (cancelBtn) {
                localStorage.setItem(getLockKey(section.dataset.level), 'true');
                lockSection(section);
                section.querySelectorAll('.attendance-card').forEach(card => {
                    card.querySelector('.attendance-input').value = currentData[card.dataset.classId] || 0;
                });
                section.querySelectorAll('.attendance-display').forEach(el => el.classList.remove('hidden'));
                section.querySelectorAll('.attendance-input').forEach(el => el.classList.add('hidden'));
                section.querySelector('.edit-mode-controls-section').classList.add('hidden');
                showNotification(`Perubahan untuk ${section.querySelector('h3').textContent} dibatalkan & dikunci.`, 'success');
            } else if (saveBtn) {
                const levelRoman = section.dataset.level;
                const updatePayload = { ...currentData };
                let hasChanges = false;
                section.querySelectorAll('.attendance-card').forEach(card => {
                    const classId = card.dataset.classId;
                    const input = card.querySelector('.attendance-input');
                    const value = parseInt(input.value, 10);
                    const finalValue = isNaN(value) || value < 0 ? 0 : value;
                    if (updatePayload[classId] !== finalValue) {
                        updatePayload[classId] = finalValue;
                        hasChanges = true;
                    }
                });
                
                if (hasChanges) {
                    saveBtn.disabled = true;
                    saveBtn.textContent = '...';
                    try {
                        localStorage.setItem(getLockKey(levelRoman), 'true');
                        await updateDoc(attendanceDocRef, updatePayload);
                        playSuccessSound();
                        showNotification(`Data ${section.querySelector('h3').textContent} berhasil disimpan & dikunci!`, 'success');
                    } catch (error) {
                        console.error("Error updating document:", error);
                        showNotification("Gagal menyimpan data. Coba lagi.", 'error');
                        localStorage.removeItem(getLockKey(levelRoman)); // Hapus kunci jika gagal
                    } finally {
                        saveBtn.disabled = false;
                        saveBtn.textContent = 'Simpan';
                    }
                }
                
                // Selalu kembali ke mode display dan kunci
                lockSection(section);
                section.querySelectorAll('.attendance-display').forEach(el => el.classList.remove('hidden'));
                section.querySelectorAll('.attendance-input').forEach(el => el.classList.add('hidden'));
                section.querySelector('.edit-mode-controls-section').classList.add('hidden');
            }
        });


        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const enteredPassword = passwordInput.value;
            if (enteredPassword === '4455') {
                playSuccessSound();
                loginModal.classList.add('transition-opacity', 'duration-500', 'opacity-0');
                setTimeout(() => {
                    loginModal.classList.add('hidden');
                    mainDashboard.classList.remove('hidden');
                    initializeDashboard();
                }, 500);
            } else {
                playTone(220, 0.2);
                errorMessage.textContent = 'Kode akses salah. Coba lagi.';
                const loginBox = loginModal.querySelector('div');
                loginBox.classList.add('animate-shake');
                passwordInput.value = '';
                setTimeout(() => {
                    errorMessage.textContent = '';
                    loginBox.classList.remove('animate-shake');
                }, 2000);
            }
        });

        let tapCount = 0;
        let tapTimer = null;
        function tripleTapHandler(event) {
             if (event.target.closest('button') || event.target.closest('input')) return;
            tapCount++;
            if (tapCount === 1) {
                tapTimer = setTimeout(() => { tapCount = 0; }, 800);
            }
            if (tapCount === 3) {
                clearTimeout(tapTimer);
                tapCount = 0;
                unlockModal.classList.remove('hidden');
            }
        }
        document.body.addEventListener('touchend', tripleTapHandler);
        document.body.addEventListener('click', tripleTapHandler);

        unlockForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const enteredPassword = unlockPasswordInput.value;
            if (enteredPassword === 'PPP') {
                playSuccessSound();
                 document.querySelectorAll('section[data-level]').forEach(section => {
                    const levelRoman = section.dataset.level;
                    localStorage.removeItem(getLockKey(levelRoman));
                    const editBtn = section.querySelector('.edit-section-btn');
                    editBtn.disabled = false;
                    editBtn.classList.add('bg-blue-600/80', 'hover:bg-blue-600');
                    editBtn.classList.remove('bg-gray-500', 'cursor-not-allowed');
                    editBtn.textContent = 'Ubah Data';
                });
                unlockModal.classList.add('hidden');
                unlockPasswordInput.value = '';
                showNotification("Semua kunci telah dibuka!", 'success');
            } else {
                playTone(220, 0.2);
                unlockErrorMessage.textContent = 'Kata sandi salah.';
                const unlockBox = unlockModal.querySelector('div');
                unlockBox.classList.add('animate-shake');
                unlockPasswordInput.value = '';
                setTimeout(() => {
                    unlockErrorMessage.textContent = '';
                    unlockBox.classList.remove('animate-shake');
                }, 2000);
            }
        });
        cancelUnlockBtn.addEventListener('click', () => {
            unlockModal.classList.add('hidden');
            unlockPasswordInput.value = '';
        });
        
        function initializeDashboard() {
            displayCurrentDate();
            renderSkeletonLoader();

            let isInitialDocLoad = true;
            onSnapshot(attendanceDocRef, (doc) => {
                const todayString = getLocalDateString();
                if (doc.exists() && doc.data().lastUpdated === todayString) {
                    currentData = doc.data();
                    renderAttendanceGrid(currentData);
                    updateSummary(currentData);
                } else {
                    if (isInitialDocLoad) {
                        isInitialDocLoad = false;
                        const resetData = { lastUpdated: todayString };
                        Object.keys(CLASSES_CONFIG).forEach(level => {
                            const levelRoman = level.split(' ')[1];
                            CLASSES_CONFIG[level].rombels.forEach(rombel => {
                                resetData[`${levelRoman}${rombel}`] = 0;
                            });
                        });
                        setDoc(attendanceDocRef, resetData).catch(error => {
                            console.error("Failed to automatically reset data:", error);
                            showNotification("Gagal memulai sesi baru.", 'error');
                        });
                    } else {
                        currentData = doc.data() || {};
                        renderAttendanceGrid(currentData);
                        updateSummary(currentData);
                    }
                }
            }, (error) => {
                console.error("Firestore onSnapshot error:", error);
                attendanceGrid.innerHTML = `<p class="text-center text-red-500 font-semibold p-4 bg-red-100 rounded-lg">Gagal terhubung ke database. Pastikan Security Rules di Firebase sudah diatur ke mode publik.</p>`;
            });
        }
    </script>
</body>
</html>

