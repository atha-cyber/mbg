<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Kehadiran - Program Makan Bergizi | SMPN 4 Pandak</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        #content-wrapper { position: relative; z-index: 1; opacity: 1; transition: opacity 0.5s ease-in; }
        #background-video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: -1; }
        #bg-video { min-width: 100%; min-height: 100%; width: auto; height: auto; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); object-fit: cover; }
        body { font-family: 'Inter', sans-serif; background-color: #0c0a18; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .animate-blinking-opacity { animation: blinking-opacity 1.5s ease-in-out infinite; }
        @keyframes blinking-opacity { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .text-glow-blue { text-shadow: 0 0 12px rgba(96, 165, 250, 0.8); }
        .text-glow-green { text-shadow: 0 0 12px rgba(74, 222, 128, 0.8); }
        .text-glow-purple { text-shadow: 0 0 12px rgba(192, 132, 252, 0.8); }
        .print-only { display: none; }
        @media print {
            @page { size: A4; margin: 1cm; }
            body { background: white !important; color: black !important; }
            .no-print, #background-video-container { display: none !important; }
            .print-only { display: block !important; }
            .header-print { display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid black; padding-bottom: 10px; }
            .report-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
            .report-table th, .report-table td { border: 1px solid black; padding: 6px; text-align: center; }
        }
    </style>
</head>
<body class="text-gray-200">
    <div id="background-video-container">
        <video autoplay loop muted playsinline id="bg-video">
            <source src="https://cdn.pixabay.com/video/2023/10/25/186421-878016905_large.mp4" type="video/mp4">
        </video>
    </div>
    
    <div id="content-wrapper">
        <div id="main-dashboard-ui">
            <!-- Modal Akses Kontrol -->
            <div id="unlock-modal" class="hidden fixed inset-0 bg-gray-900/95 backdrop-blur-lg flex items-center justify-center z-50 p-4 no-print">
                <div class="w-full max-w-sm bg-gray-800 border border-white/10 rounded-2xl p-8 shadow-2xl">
                    <form id="unlock-form">
                        <h2 class="text-2xl font-bold text-center mb-6">Akses Kontrol</h2>
                        <input type="password" id="unlock-password-input" placeholder="Sandi Admin" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 mb-4 text-center text-xl focus:ring-2 focus:ring-yellow-500 outline-none text-white">
                        <button type="submit" class="w-full bg-yellow-600 hover:bg-yellow-700 py-3 rounded-lg font-bold transition">Masuk</button>
                        <button type="button" id="cancel-unlock-btn" class="w-full mt-2 text-gray-400 py-2">Batal</button>
                    </form>
                    <div id="class-unlock-options" class="hidden space-y-4">
                        <h3 class="text-center font-bold text-yellow-500">Panel Superuser</h3>
                        <button type="button" id="unlock-all-btn" class="w-full bg-blue-600 py-3 rounded-lg font-bold">Buka Semua Kunci</button>
                        <button type="button" id="reset-data-btn" class="w-full bg-red-600 py-3 rounded-lg font-bold">Reset Data Harian</button>
                        <button type="button" id="done-unlocking-btn" class="w-full bg-gray-600 py-2 rounded-lg mt-4 text-white">Tutup Panel</button>
                    </div>
                </div>
            </div>

            <header class="relative p-6 sm:p-10 border-b border-white/10 bg-black/50 backdrop-blur-md">
                <div class="container mx-auto flex flex-col sm:flex-row items-center justify-between gap-6">
                    <img src="https://raw.githubusercontent.com/atha-cyber/logo-/main/images.jfif" alt="Logo Sekolah" class="h-20 w-20 rounded-full bg-white p-1">
                    <div class="text-center">
                        <h1 class="text-2xl sm:text-4xl font-black tracking-tight text-white uppercase">Dasbor Kehadiran MBG</h1>
                        <p class="text-yellow-500 font-bold uppercase tracking-widest text-sm sm:text-base">SMP NEGERI 4 PANDAK</p>
                        <p id="current-date" class="mt-2 text-gray-400 text-sm font-medium"></p>
                    </div>
                    <img src="https://raw.githubusercontent.com/atha-cyber/logo-/main/logo-bgn.png" alt="Logo MBG" class="h-20 w-20 object-contain">
                </div>
            </header>
            
            <div class="container mx-auto px-4 py-8">
                <main id="attendance-grid" class="space-y-10"></main>
                
                <section id="summary-section" class="bg-black/60 backdrop-blur-xl p-8 rounded-3xl mt-12 border border-white/10 shadow-2xl">
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="text-2xl font-black italic text-white">RANGKUMAN PORSI</h3>
                        <button id="print-btn" class="no-print bg-white/10 hover:bg-white/20 p-4 rounded-2xl transition-all active:scale-95 text-white">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M5 1a2 2 0 0 0-2 2v1h10V3a2 2 0 0 0-2-2zM11 8H5a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V9a1 1 0 0 0-1-1z"/><path d="M1 7a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v-2a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2H2a2 2 0 0 1-2-2z"/></svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-blue-500/10 border border-blue-500/20 p-5 rounded-2xl text-center">
                            <p class="text-xs font-bold text-blue-400 uppercase mb-2">Kelas VII</p>
                            <p id="total-vii" class="text-4xl font-black">0</p>
                        </div>
                        <div class="bg-green-500/10 border border-green-500/20 p-5 rounded-2xl text-center">
                            <p class="text-xs font-bold text-green-400 uppercase mb-2">Kelas VIII</p>
                            <p id="total-viii" class="text-4xl font-black">0</p>
                        </div>
                        <div class="bg-purple-500/10 border border-purple-500/20 p-5 rounded-2xl text-center">
                            <p class="text-xs font-bold text-purple-400 uppercase mb-2">Kelas IX</p>
                            <p id="total-ix" class="text-4xl font-black">0</p>
                        </div>
                        <div class="bg-yellow-500/20 border border-yellow-500/40 p-5 rounded-2xl text-center col-span-2 lg:col-span-1 shadow-lg shadow-yellow-500/10">
                            <p class="text-xs text-yellow-500 font-black uppercase mb-2">Total Hadir</p>
                            <p id="total-present" class="text-5xl font-black text-white">0</p>
                            <div class="mt-3 pt-3 border-t border-white/10">
                                <p class="text-[10px] text-red-400 font-bold uppercase tracking-tighter">Sisa Porsi</p>
                                <p id="remaining-portions" class="text-2xl font-black text-red-500 animate-blinking-opacity">0</p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Tampilan Cetak -->
        <div id="print-output" class="print-only">
            <div class="header-print">
                <img src="https://raw.githubusercontent.com/atha-cyber/logo-/main/images.jfif" height="70">
                <div style="text-align:center">
                    <h1 style="margin:0; font-size: 24px;">LAPORAN KEHADIRAN MBG</h1>
                    <h2 style="margin:0; font-size: 18px;">SMP NEGERI 4 PANDAK</h2>
                </div>
                <img src="https://raw.githubusercontent.com/atha-cyber/logo-/main/logo-bgn.png" height="70">
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 15px; font-weight: bold;">
                <p id="print-date-display"></p>
                <p>Total Porsi Terpakai: <span id="print-total-val">0</span></p>
            </div>
            <table class="report-table">
                <thead>
                    <tr>
                        <th width="30%">KELAS / UNIT</th>
                        <th width="20%">HADIR</th>
                        <th width="50%">KETERANGAN</th>
                    </tr>
                </thead>
                <tbody id="print-table-body"></tbody>
            </table>
            <div style="margin-top: 40px; display: flex; justify-content: flex-end;">
                <div style="text-align: center; width: 200px;">
                    <p>Petugas MBG,</p>
                    <div style="height: 80px;"></div>
                    <p>( ................................ )</p>
                </div>
            </div>
        </div>
    </div>

    <audio id="scroll-sound" src="https://raw.githubusercontent.com/atha-cyber/logo-/a2f4c0f6a47da76d0641baf965a40276587660bd/scrollll.wav" preload="auto"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfigurasi Environment Aman
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "", // Masukkan API Key Anda di sini jika menjalankan lokal
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-mbg-app';
        const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DATA KELAS (Konfigurasi Utama - Sumber Kebenaran Tampilan)
        const CLASSES_CONFIG = {
            'Kelas VII': { color: 'blue', rombels: ['A', 'B', 'C', 'D', 'E'] },
            'Kelas VIII': { color: 'green', rombels: ['A', 'B', 'C', 'D', 'E'] },
            'Kelas IX': { color: 'purple', rombels: ['A', 'B', 'C', 'D', 'E'] }
        };
        
        const TOTAL_PORSI = 472; 
        const SECRET_ACCESS = "MBG4PANDAK"; 

        let user = null;
        let currentAttendanceData = {};

        const initAuth = async () => {
            try {
                if (initialToken && initialToken !== "") await signInWithCustomToken(auth, initialToken);
                else await signInAnonymously(auth);
            } catch (err) { 
                console.error("Auth error:", err); 
            }
        };

        const getTodayId = () => {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        };

        const docPath = `artifacts/${appId}/public/data/daily_rekap/rekap-${getTodayId()}`;

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) startApp();
        });

        const startApp = () => {
            const attendanceDocRef = doc(db, docPath);
            
            // Listener untuk data dari database
            onSnapshot(attendanceDocRef, (snap) => {
                currentAttendanceData = snap.exists() ? snap.data() : {};
                
                // Pastikan UI ter-update dengan data terbaru
                renderUI(currentAttendanceData);
                
                // Jika dokumen belum ada di database, buat dokumen baru dengan struktur lengkap A-E
                if (!snap.exists()) {
                    createEmptyData();
                }
            }, (err) => {
                console.error("Firestore error:", err);
                // Jika error (misal koneksi lokal bermasalah), tetap render UI kosong agar tidak pecah
                renderUI({});
            });
        };

        const createEmptyData = async () => {
            if (!user) return;
            const initial = { date: getTodayId(), locks: {} };
            Object.entries(CLASSES_CONFIG).forEach(([level, details]) => {
                const levelRoman = level.split(' ')[1];
                details.rombels.forEach(r => {
                    const id = `${levelRoman}${r}`;
                    initial[id] = 0;
                    initial.locks[id] = false;
                });
            });
            try {
                await setDoc(doc(db, docPath), initial);
            } catch (e) {
                console.error("Gagal membuat data awal:", e);
            }
        };

        const renderUI = (data) => {
            const grid = document.getElementById('attendance-grid');
            let html = '';
            let totalOverall = 0;
            const summary = { vii: 0, viii: 0, ix: 0 };

            // Render BERDASARKAN CLASSES_CONFIG agar daftar rombel A-E selalu konsisten
            for (const [level, details] of Object.entries(CLASSES_CONFIG)) {
                let levelSum = 0;
                const levelRoman = level.split(' ')[1];

                html += `
                <div class="bg-black/30 rounded-3xl p-6 border border-white/5 shadow-inner">
                    <h3 class="text-xl font-bold mb-6 flex items-center gap-3">
                        <span class="w-3 h-3 rounded-full bg-${details.color}-500 shadow-[0_0_10px_rgba(0,0,0,0.5)]"></span>
                        ${level}
                    </h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">`;

                details.rombels.forEach(rombel => {
                    const id = `${levelRoman}${rombel}`;
                    // Jika data[id] tidak ada di DB, tampilkan 0
                    const count = (data && data[id] !== undefined) ? data[id] : 0;
                    const locked = (data && data.locks && data.locks[id]) || false;
                    levelSum += count;

                    html += `
                        <div class="relative bg-white/5 border border-white/10 p-4 rounded-2xl text-center group hover:border-${details.color}-500/50 transition-all duration-300" data-class="${id}">
                            <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">${levelRoman} ${rombel}</p>
                            <div class="text-3xl font-black text-white text-glow-${details.color} display-val">${count}</div>
                            <input type="number" class="hidden input-val w-full bg-black/80 border border-${details.color}-500 rounded-xl p-1 text-center font-bold text-2xl text-white outline-none" value="${count}">
                            
                            <div class="mt-3 min-h-[24px]">
                                ${locked ? 
                                    '<span class="text-[9px] text-gray-600 font-bold uppercase tracking-widest flex items-center justify-center gap-1"><svg class="w-2 h-2" fill="currentColor" viewBox="0 0 16 16"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/></svg> Terkunci</span>' : 
                                    `<button class="btn-edit text-[9px] bg-${details.color}-600/20 hover:bg-${details.color}-600 text-white px-3 py-1 rounded-full font-black uppercase transition-all active:scale-90">Ubah</button>`
                                }
                                <div class="hidden edit-controls flex justify-center gap-2">
                                    <button class="btn-save bg-green-600 text-white text-[10px] px-3 py-1 rounded-lg font-bold">Simpan</button>
                                    <button class="btn-cancel bg-gray-600 text-white text-[10px] px-2 py-1 rounded-lg">X</button>
                                </div>
                            </div>
                        </div>`;
                });

                html += `</div></div>`;
                
                if (levelRoman === 'VII') summary.vii = levelSum;
                else if (levelRoman === 'VIII') summary.viii = levelSum;
                else if (levelRoman === 'IX') summary.ix = levelSum;
                
                totalOverall += levelSum;
            }

            grid.innerHTML = html;
            
            document.getElementById('total-vii').textContent = summary.vii;
            document.getElementById('total-viii').textContent = summary.viii;
            document.getElementById('total-ix').textContent = summary.ix;
            document.getElementById('total-present').textContent = totalOverall;
            document.getElementById('remaining-portions').textContent = Math.max(0, TOTAL_PORSI - totalOverall);

            attachEvents();
        };

        const attachEvents = () => {
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.onclick = (e) => {
                    const card = e.target.closest('[data-class]');
                    card.querySelector('.display-val').classList.add('hidden');
                    card.querySelector('.input-val').classList.remove('hidden');
                    card.querySelector('.edit-controls').classList.remove('hidden');
                    card.querySelector('.input-val').focus();
                    e.target.classList.add('hidden');
                };
            });

            document.querySelectorAll('.btn-cancel').forEach(btn => {
                btn.onclick = () => renderUI(currentAttendanceData);
            });

            document.querySelectorAll('.btn-save').forEach(btn => {
                btn.onclick = async (e) => {
                    const card = e.target.closest('[data-class]');
                    const classId = card.dataset.class;
                    const newVal = parseInt(card.querySelector('.input-val').value) || 0;
                    
                    if (!user) return;
                    try {
                        await updateDoc(doc(db, docPath), {
                            [classId]: newVal,
                            [`locks.${classId}`]: true
                        });
                    } catch (err) {
                        console.error("Gagal menyimpan data:", err);
                        alert("Gagal menyimpan! Periksa koneksi atau konfigurasi Firebase.");
                    }
                };
            });
        };

        // Inisialisasi awal UI kosong agar rombel langsung muncul
        renderUI({});

        // UI Helpers
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

        const scrollSound = document.getElementById('scroll-sound');
        window.onscroll = () => {
            if (scrollSound.paused) {
                scrollSound.currentTime = 0;
                scrollSound.play().catch(() => {});
                setTimeout(() => scrollSound.pause(), 400);
            }
        };

        // Admin Auth
        let tapCount = 0;
        document.querySelector('header').onclick = () => {
            tapCount++;
            if (tapCount >= 5) {
                document.getElementById('unlock-modal').classList.remove('hidden');
                tapCount = 0;
            }
            setTimeout(() => tapCount = 0, 3000);
        };

        document.getElementById('unlock-form').onsubmit = (e) => {
            e.preventDefault();
            if (document.getElementById('unlock-password-input').value === SECRET_ACCESS) {
                document.getElementById('unlock-form').classList.add('hidden');
                document.getElementById('class-unlock-options').classList.remove('hidden');
            } else {
                alert("Sandi salah!");
            }
        };

        document.getElementById('cancel-unlock-btn').onclick = () => {
            document.getElementById('unlock-modal').classList.add('hidden');
            document.getElementById('unlock-password-input').value = "";
        };

        document.getElementById('reset-data-btn').onclick = async () => {
            if (confirm("PERHATIAN: Hapus semua data kehadiran hari ini?")) {
                await createEmptyData();
                location.reload();
            }
        };

        document.getElementById('unlock-all-btn').onclick = async () => {
            if (!user) return;
            const newLocks = {};
            // Loop melalui konfigurasi rombel yang benar (A-E)
            Object.entries(CLASSES_CONFIG).forEach(([level, details]) => {
                const levelRoman = level.split(' ')[1];
                details.rombels.forEach(r => {
                    newLocks[`locks.${levelRoman}${r}`] = false;
                });
            });
            await updateDoc(doc(db, docPath), newLocks);
            location.reload();
        };

        document.getElementById('done-unlocking-btn').onclick = () => {
            document.getElementById('unlock-modal').classList.add('hidden');
            document.getElementById('unlock-form').classList.remove('hidden');
            document.getElementById('class-unlock-options').classList.add('hidden');
            document.getElementById('unlock-password-input').value = "";
        };

        document.getElementById('print-btn').onclick = () => {
            const body = document.getElementById('print-table-body');
            body.innerHTML = '';
            
            Object.entries(CLASSES_CONFIG).forEach(([level, details]) => {
                const levelRoman = level.split(' ')[1];
                details.rombels.forEach(r => {
                    const id = `${levelRoman}${r}`;
                    const val = currentAttendanceData[id] || 0;
                    body.innerHTML += `<tr><td>${levelRoman} ${r}</td><td>${val}</td><td></td></tr>`;
                });
            });

            document.getElementById('print-total-val').textContent = document.getElementById('total-present').textContent;
            document.getElementById('print-date-display').textContent = "Tanggal: " + document.getElementById('current-date').textContent;
            window.print();
        };

        initAuth();
    </script>
</body>
</html>
